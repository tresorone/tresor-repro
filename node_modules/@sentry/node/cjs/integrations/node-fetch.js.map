{"version":3,"file":"node-fetch.js","sources":["../../../src/integrations/node-fetch.ts"],"sourcesContent":["import type { Span } from '@opentelemetry/api';\nimport { addBreadcrumb, defineIntegration } from '@sentry/core';\nimport { addOpenTelemetryInstrumentation } from '@sentry/opentelemetry';\nimport type { IntegrationFn, SanitizedRequestData } from '@sentry/types';\nimport { getSanitizedUrlString, logger, parseUrl } from '@sentry/utils';\nimport { DEBUG_BUILD } from '../debug-build';\nimport { NODE_MAJOR } from '../nodeVersion';\n\nimport type { FetchInstrumentation } from 'opentelemetry-instrumentation-fetch-node';\n\nimport { addOriginToSpan } from '../utils/addOriginToSpan';\n\ninterface FetchRequest {\n  method: string;\n  origin: string;\n  path: string;\n  headers: string | string[];\n}\n\ninterface FetchResponse {\n  headers: Buffer[];\n  statusCode: number;\n}\n\ninterface NodeFetchOptions {\n  /**\n   * Whether breadcrumbs should be recorded for requests.\n   * Defaults to true\n   */\n  breadcrumbs?: boolean;\n\n  /**\n   * Do not capture spans or breadcrumbs for outgoing fetch requests to URLs where the given callback returns `true`.\n   * This controls both span & breadcrumb creation - spans will be non recording if tracing is disabled.\n   */\n  ignoreOutgoingRequests?: (url: string) => boolean;\n}\n\nconst _nativeNodeFetchIntegration = ((options: NodeFetchOptions = {}) => {\n  const _breadcrumbs = typeof options.breadcrumbs === 'undefined' ? true : options.breadcrumbs;\n  const _ignoreOutgoingRequests = options.ignoreOutgoingRequests;\n\n  async function getInstrumentation(): Promise<FetchInstrumentation | void> {\n    // Only add NodeFetch if Node >= 18, as previous versions do not support it\n    if (NODE_MAJOR < 18) {\n      DEBUG_BUILD && logger.log('NodeFetch is not supported on Node < 18, skipping instrumentation...');\n      return;\n    }\n\n    try {\n      const pkg = await import('opentelemetry-instrumentation-fetch-node');\n      const { FetchInstrumentation } = pkg;\n\n      class SentryNodeFetchInstrumentation extends FetchInstrumentation {\n        // We extend this method so we have access to request _and_ response for the breadcrumb\n        public onHeaders({ request, response }: { request: FetchRequest; response: FetchResponse }): void {\n          if (_breadcrumbs) {\n            _addRequestBreadcrumb(request, response);\n          }\n\n          return super.onHeaders({ request, response });\n        }\n      }\n\n      return new SentryNodeFetchInstrumentation({\n        ignoreRequestHook: (request: { origin?: string }) => {\n          const url = request.origin;\n          return _ignoreOutgoingRequests && url && _ignoreOutgoingRequests(url);\n        },\n        onRequest: ({ span }: { span: Span }) => {\n          _updateSpan(span);\n        },\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      } as any);\n    } catch (error) {\n      // Could not load instrumentation\n      DEBUG_BUILD && logger.log('Could not load NodeFetch instrumentation.');\n    }\n  }\n\n  return {\n    name: 'NodeFetch',\n    setupOnce() {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      getInstrumentation().then(instrumentation => {\n        if (instrumentation) {\n          addOpenTelemetryInstrumentation(instrumentation);\n        }\n      });\n    },\n  };\n}) satisfies IntegrationFn;\n\nexport const nativeNodeFetchIntegration = defineIntegration(_nativeNodeFetchIntegration);\n\n/** Update the span with data we need. */\nfunction _updateSpan(span: Span): void {\n  addOriginToSpan(span, 'auto.http.otel.node_fetch');\n}\n\n/** Add a breadcrumb for outgoing requests. */\nfunction _addRequestBreadcrumb(request: FetchRequest, response: FetchResponse): void {\n  const data = getBreadcrumbData(request);\n\n  addBreadcrumb(\n    {\n      category: 'http',\n      data: {\n        status_code: response.statusCode,\n        ...data,\n      },\n      type: 'http',\n    },\n    {\n      event: 'response',\n      request,\n      response,\n    },\n  );\n}\n\nfunction getBreadcrumbData(request: FetchRequest): Partial<SanitizedRequestData> {\n  try {\n    const url = new URL(request.path, request.origin);\n    const parsedUrl = parseUrl(url.toString());\n\n    const data: Partial<SanitizedRequestData> = {\n      url: getSanitizedUrlString(parsedUrl),\n      'http.method': request.method || 'GET',\n    };\n\n    if (parsedUrl.search) {\n      data['http.query'] = parsedUrl.search;\n    }\n    if (parsedUrl.hash) {\n      data['http.fragment'] = parsedUrl.hash;\n    }\n\n    return data;\n  } catch {\n    return {};\n  }\n}\n"],"names":["NODE_MAJOR","DEBUG_BUILD","logger","addOpenTelemetryInstrumentation","defineIntegration","addOriginToSpan","addBreadcrumb","parseUrl","getSanitizedUrlString"],"mappings":"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"}